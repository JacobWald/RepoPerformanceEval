{% extends "analytics/base.html" %} {% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'styles/dashboard.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'styles/variables.css' %}" />


<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">Repository Dashboard</h1>
    <p class="dashboard-subtitle">GitHub URL analysis result</p>
  </div>

  <!-- Repo summary -->
  <div class="repo-summary-card">
    <div class="repo-summary-grid">
      <div class="repo-summary-main">
        <div class="repo-name">{{ repo.name }}</div>
        <div class="repo-url">{{ repo.url }}</div>
      </div>
    </div>
  </div>

  <!-- Buttons -->
  <div class="dashboard-tabs">
    <button
      id="btn-overall"
      type="button"
      class="tab-button tab-button--active"
    >
      Overall Analysis Result
    </button>

    <button id="btn-devs" type="button" class="tab-button">
      Developer-specific Analysis
    </button>
  </div>

  <!-- Child content container -->
  <div id="tab-content" class="tab-content">
    <!-- Child HTML will be loaded here -->
  </div>
</div>

<script>
  // -------Overall Project Summary Bar--------
  function initActivityBar() {
    const container = document.getElementById("activity-bar");
    if (!container) {
      // Not on the overall tab
      return;
    }

    const jsonUrl = container.dataset.jsonUrl;
    console.log("jsonUrl from data attribute:", jsonUrl);
    if (!jsonUrl) return;

    fetch(jsonUrl)
      .then((res) => {
        console.log("fetch status:", res.status);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then((data) => {
        console.log("analytics JSON loaded (overall):", data);

        const summary = data.repo_summary || {};
        const mining = data.mining_params || {};

        const daysWindow = mining.days_window || null;
        if (daysWindow) {
          const span = document.getElementById("activity-days-window");
          if (span) span.textContent = daysWindow;
        }

        const totalCommits = summary.total_commits || 0;
        const totalInsertions = summary.total_insertions || 0;
        const totalDeletions = summary.total_deletions || 0;
        const totalCiRuns = summary.total_ci_runs || 0;

        const ciTotals = summary.ci_status_totals || {};
        const failed = ciTotals.failure || 0;
        const success = ciTotals.success || 0;

        const ciCoveredCommits = summary.ci_covered_commits || 0;
        const ciCoverageRatio =
          summary.ci_coverage_ratio ||
          (totalCommits ? ciCoveredCommits / totalCommits : 0);

        const failurePct = totalCiRuns ? (failed / totalCiRuns) * 100 : 0;
        const prDenom = success + failed;
        const prSuccessPct = prDenom ? (success / prDenom) * 100 : 0;
        const ciCoveragePct = ciCoverageRatio * 100;

        const commitsSeg = container.querySelector(
          ".activity-bar-segment.commits"
        );
        const linesSeg = container.querySelector(".activity-bar-segment.lines");
        const ciSeg = container.querySelector(".activity-bar-segment.ci");

        if (commitsSeg) {
          commitsSeg.title = `${totalCommits.toLocaleString()} commits`;
        }
        const totalLinesChanged = totalInsertions + totalDeletions;
        if (linesSeg) {
          linesSeg.title = `${totalLinesChanged.toLocaleString()} total lines changed`;
        }
        if (ciSeg) {
          ciSeg.title = `${totalCiRuns.toLocaleString()} CI runs (${failurePct.toFixed(
            1
          )}% failed)`;
        }

        const setText = (selector, text) => {
          const el = container.querySelector(selector);
          if (el) el.textContent = text;
        };

        setText(
          '[data-stat="commits"]',
          `${totalCommits.toLocaleString()} commits`
        );

        setText(
          '[data-stat="commits-ci"]',
          `${ciCoveredCommits.toLocaleString()} commits with CI (${ciCoveragePct.toFixed(
            1
          )}% of commits)`
        );

        setText(
          '[data-stat="lines-added"]',
          `${totalInsertions.toLocaleString()} lines added`
        );

        setText(
          '[data-stat="lines-deleted"]',
          `${totalDeletions.toLocaleString()} lines deleted`
        );

        setText(
          '[data-stat="ci-runs"]',
          `${totalCiRuns.toLocaleString()} CI runs`
        );

        setText(
          '[data-stat="ci-failure"]',
          totalCiRuns ? `${failurePct.toFixed(1)}% failed` : "n/a"
        );

        setText(
          '[data-stat="pr-success"]',
          prDenom ? `${prSuccessPct.toFixed(1)}% success` : "n/a"
        );
      })
      .catch((err) => {
        console.error("Failed to load analytics JSON (overall)", err);
        if (!container) return;
        container.classList.add("activity-bar--error");
        const inner = container.querySelector(".activity-bar-inner");
        if (inner) inner.textContent = "Unable to load project analytics.";
      });
  }

  // -------CI Reliability Charts--------
  let ciCharts = [];

  function initCiReliabilityCharts() {
    const weeklyCanvas = document.getElementById("ci-weekly-chart");
    const weeklyCommitsCanvas = document.getElementById("ci-weekly-commits-chart");
    if (!weeklyCanvas && !weeklyCommitsCanvas) return;

    const activity = document.getElementById("activity-bar");
    if (!activity) return;

    const jsonUrl = activity.dataset.jsonUrl;
    if (!jsonUrl) return;

    // destroy any old charts when re-opening tab
    ciCharts.forEach((c) => c && c.destroy && c.destroy());
    ciCharts = [];

    // helper: derive ISO week bucket "YYYY-Www" from ISO date string
    function isoWeekBucketFromIsoString(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      if (isNaN(d)) return null;

      // work in UTC to avoid TZ issues
      const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = utc.getUTCDay() || 7;       // 1=Mon ... 7=Sun
      utc.setUTCDate(utc.getUTCDate() + 4 - dayNum); // move to Thursday

      const yearStart = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil(((utc - yearStart) / 86400000 + 1) / 7);

      return (
        utc.getUTCFullYear() +
        "-W" +
        String(weekNo).padStart(2, "0")
      );
    }

    fetch(jsonUrl)
      .then((res) => {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then((data) => {
        const summary = data.repo_summary || {};
        const weeklyCi = summary.ci_weekly_success_failure || {};

        // theme colors from CSS variables
        const styles = getComputedStyle(document.documentElement);
        const colorPrimary =
          styles.getPropertyValue("--color-primary").trim() || "#555879";
        const colorSecondary =
          styles.getPropertyValue("--color-secondary").trim() || "#DED3C4";
        const colorFailure = "#e76f51";

        // ---------- Chart 1: weekly CI success vs failure (unchanged) ----------
        if (weeklyCanvas) {
          const weeks = Object.keys(weeklyCi).sort();
          const success = weeks.map((w) => weeklyCi[w].success || 0);
          const failure = weeks.map((w) => weeklyCi[w].failure || 0);

          const weeklyChart = new Chart(weeklyCanvas.getContext("2d"), {
            type: "bar",
            data: {
              labels: weeks,
              datasets: [
                {
                  label: "Successful runs",
                  data: success,
                  backgroundColor: colorPrimary,
                  stack: "ci",
                },
                {
                  label: "Failed runs",
                  data: failure,
                  backgroundColor: colorFailure,
                  stack: "ci",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "bottom" },
                title: { display: false },
              },
              scales: {
                x: { stacked: true },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  title: { display: true, text: "CI runs per week" },
                },
              },
            },
          });

          ciCharts.push(weeklyChart);
        }

        // ---------- Chart 2: weekly commits vs failed CI runs ----------
        if (weeklyCommitsCanvas) {
          // Count commits per ISO week bucket
          const weeklyCommits = {};
          (data.authors || []).forEach((author) => {
            (author.commits || []).forEach((c) => {
              const bucket = isoWeekBucketFromIsoString(c.author_date);
              if (!bucket) return;
              weeklyCommits[bucket] = (weeklyCommits[bucket] || 0) + 1;
            });
          });

          // Combine all week keys from commits + CI failure stats
          const allWeeks = Array.from(
            new Set([
              ...Object.keys(weeklyCommits),
              ...Object.keys(weeklyCi),
            ])
          ).sort();

          const commitsData = allWeeks.map((w) => weeklyCommits[w] || 0);
          const failuresData = allWeeks.map(
            (w) => (weeklyCi[w] && weeklyCi[w].failure) || 0
          );

          const weeklyCommitsChart = new Chart(
            weeklyCommitsCanvas.getContext("2d"),
            {
              type: "bar",
              data: {
                labels: allWeeks,
                datasets: [
                  {
                    label: "Commits",
                    data: commitsData,
                    backgroundColor: colorPrimary,
                    yAxisID: "y",
                  },
                  {
                    label: "Failed CI runs",
                    data: failuresData,
                    backgroundColor: colorFailure,
                    yAxisID: "y1",
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: "bottom" },
                  title: { display: false },
                },
                scales: {
                  x: {
                    stacked: false,
                  },
                  y: {
                    beginAtZero: true,
                    title: { display: true, text: "Commits per week" },
                  },
                  y1: {
                    beginAtZero: true,
                    position: "right",
                    grid: { drawOnChartArea: false },
                    title: {
                      display: true,
                      text: "Failed CI runs per week",
                    },
                  },
                },
              },
            }
          );

          ciCharts.push(weeklyCommitsChart);
        }
      })
      .catch((err) => {
        console.error("Failed to load CI reliability data", err);
      });
  }
  // -------Developer Specific Panel--------
  function initDeveloperPanel() {
    const panel = document.getElementById("developer-panel");
    const smallCard = panel.querySelector(".small-activity-card");
    const commitsCard = panel.querySelector(".commit-table").closest(".activity-card");
    if (!panel) {
      // Not on devs tab
      return;
    }
    let ciChart = null;
    const jsonUrl = panel.dataset.jsonUrl;
    console.log("dev panel jsonUrl:", jsonUrl);
    if (!jsonUrl) return;

    fetch(jsonUrl)
      .then((res) => {
        console.log("fetch status (devs):", res.status);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then((data) => {
        console.log("analytics JSON loaded (devs):", data);
        const authors = data.authors || [];

        const dropdown = panel.querySelector("#dev-dropdown");
        const toggleBtn = panel.querySelector("#dev-dropdown-toggle");
        const labelSpan = panel.querySelector("#dev-dropdown-label");
        const menu = panel.querySelector("#dev-dropdown-menu");
        const searchInput = panel.querySelector("#dev-dropdown-search");
        const listEl = panel.querySelector("#dev-dropdown-list");

        const titleEl = panel.querySelector("#dev-insights-title");
        const subtitleEl = panel.querySelector("#dev-insights-subtitle");

        if (!dropdown || !toggleBtn || !menu || !searchInput || !listEl) {
          console.warn("Developer dropdown elements not found");
          return;
        }

        function setStat(key, text) {
          const el = panel.querySelector(`[data-dev-stat="${key}"]`);
          if (el) el.textContent = text;
        }

        function setHeading(dev) {
          if (!titleEl || !subtitleEl) return;

          if (!dev) {
            titleEl.textContent = "Developer Insights";
            subtitleEl.textContent =
              "Select a developer from the dropdown to see per-developer statistics.";
            return;
          }

          const name = dev.name || "Unknown developer";
          const email = dev.email || "";

          titleEl.textContent = `Insights for ${name}`;
          subtitleEl.textContent = email || "";
        }

        function renderDeveloper(dev) {
          if (!dev) {
            setStat("commits", "–");
            setStat("lines", "–");
            setStat("streak", "–");
            setStat("active-day", "–");
            setStat("active-hour", "–");
            setStat("ci-failure-ratio", "–");
            setStat("ci-runs", "–");
            setHeading(null);
            if (smallCard) smallCard.style.display = "none";
            if (commitsCard) commitsCard.style.display = "none";
            return;
          }

          if (smallCard) smallCard.style.display = "";
          if (commitsCard) commitsCard.style.display = "";

          const name = dev.name || "Unknown";
          const email = dev.email || "–";
          const commits =
            dev.commit_count ||
            (Array.isArray(dev.commits) ? dev.commits.length : 0) ||
            0;
          const insertions = dev.total_insertions || 0;
          const deletions = dev.total_deletions || 0;
          const avgStreak =
            typeof dev.average_streak_days === "number"
              ? dev.average_streak_days.toFixed(2)
              : "n/a";

          // Most active weekday
          const weekdayFreq = dev.weekday_frequency || {};
          let bestDay = "n/a";
          let bestDayCount = 0;
          Object.entries(weekdayFreq).forEach(([day, count]) => {
            if (count > bestDayCount) {
              bestDay = day;
              bestDayCount = count;
            }
          });

          // Most active hour from dev.commits[].author_hour
          let bestHourLabel = "n/a";
          if (Array.isArray(dev.commits) && dev.commits.length > 0) {
            const hourCounts = new Array(24).fill(0);
            dev.commits.forEach((c) => {
              const h = c.author_hour;
              if (typeof h === "number" && h >= 0 && h < 24) {
                hourCounts[h] += 1;
              }
            });

            let bestHour = 0;
            let bestHourCount = 0;
            hourCounts.forEach((count, hour) => {
              if (count > bestHourCount) {
                bestHour = hour;
                bestHourCount = count;
              }
            });

            if (bestHourCount > 0) {
              bestHourLabel = `${bestHour}:00 hour`;
            }
          }

          // CI failures / total CI runs for this dev
          const ciTotals = dev.ci_conclusions_totals || {};
          const ciFailures = ciTotals.failure || 0;
          const totalCiRuns = Object.values(ciTotals).reduce(
            (sum, v) => sum + (v || 0),
            0
          );
          const failurePct = totalCiRuns
            ? ((ciFailures / totalCiRuns) * 100).toFixed(1)
            : null;

          setStat("commits", `${commits.toLocaleString()} commits`);
          setStat(
            "lines",
            `${insertions.toLocaleString()} + / ${deletions.toLocaleString()} -`
          );
          setStat("streak", avgStreak);
          setStat(
            "active-day",
            bestDayCount ? `${bestDay} (${bestDayCount} commits)` : "n/a"
          );
          setStat("active-hour", bestHourLabel);
          setStat(
            "ci-runs",
            totalCiRuns ? `${totalCiRuns} CI runs` : "no CI data"
          );
          setStat(
            "ci-failure-ratio",
            totalCiRuns
              ? `${ciFailures}/${totalCiRuns} (${failurePct}% failed)`
              : "n/a"
          );
          

          function renderCiBarChart(ciTotals, totalCiRuns) {
            const ctx = document.getElementById("ciBarChart");

            if (!ctx) {
              console.warn("ciBarChart canvas not found");
              return;
            }

            if (ciChart) {
                ciChart.destroy(); // ❗ necessary for updating scales or data
            }

            const successCount = ciTotals.success || 0
            const failedCount = ciTotals.failure || 0
            const skippedCount = totalCiRuns - successCount - failedCount
            //const barColor = styles.getPropertyValue("--color-secondary").trim();
            const colorSecondary = getComputedStyle(document.documentElement)
              .getPropertyValue('--color-secondary')
              .trim();


            ciChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: ["Success", "Failed", "Skipped"],
                datasets: [
                  {
                    label: "",
                    data: [successCount, failedCount, skippedCount],
                    backgroundColor: colorSecondary,
                    //borderColor: 'white',
                    //borderWidth: 1.5
                    
                  }
                ]
              },
              options: {
                indexAxis: "y", // ← MAKES THE CHART HORIZONTAL
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false   // hides legend completely
                  },
                  title: {
                    display: true,
                    text: "CI Runs",
                    color: colorSecondary,
                    font: { size: 18 }
                  }
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    ticks: { color: colorSecondary},
                    grid: { color: colorSecondary }
                  },
                  y: {
                    ticks: { color: colorSecondary},
                    grid: { color:colorSecondary }
                  }
                }
              }
            });
          }
          function renderCommitTable(dev) {
            const tbody = document.getElementById("commitTableBody");
            tbody.innerHTML = ""; // clear old rows
            
            if (!dev || !Array.isArray(dev.commits) || dev.commits.length === 0) {
              tbody.innerHTML = `
                <tr><td colspan="6" style="text-align:center; opacity:0.7;">No commits available</td></tr>
              `;
              return;
            }
            dev.commits.forEach(commit => {
              const d = new Date(commit.committer_date);
              const date = d.toLocaleDateString();
              const time = d.toLocaleTimeString();
              const commitUrl = `https://github.com/google/${data.repo_name}/commit/${commit.hash}`;

              const row = document.createElement("tr");
              //this is what i need to edit
              row.innerHTML = `
                <td>${date}</td>
                <td>${time}</td>
                <td>${commit.msg || "—"}</td>
                <td>${commit.ci_result || "—"}</td>
                <td>+${commit.insertions || 0} / -${commit.deletions || 0}</td>
                <td><a href="${commitUrl}" targets="_blank">View</a></td>
              `;
              //end of what i need to edit
              tbody.appendChild(row);
            });
          }

          setHeading({ name, email });
          renderCiBarChart(ciTotals, totalCiRuns);
          renderCommitTable(dev);
        }

        // Populate the <ul> based on filter
        function populateList(filterTerm = "") {
          const term = filterTerm.trim().toLowerCase();
          listEl.innerHTML = "";

          const filtered = term
            ? authors.filter((a) => {
                const n = (a.name || "").toLowerCase();
                const e = (a.email || "").toLowerCase();
                return n.includes(term) || e.includes(term);
              })
            : authors;

          filtered.forEach((a) => {
            const li = document.createElement("li");
            const valueKey = a.email || a.name || "";
            li.dataset.key = valueKey;
            li.className = "dev-dropdown-item";
            li.textContent = a.email
              ? `${a.name} (${a.email})`
              : a.name || "Unknown";
            listEl.appendChild(li);
          });

          if (filtered.length === 0) {
            renderDeveloper(null);
          }
        }

        // Toggle menu open/close
        function openMenu() {
          dropdown.classList.add("dev-dropdown--open");
          menu.style.display = "block";
          searchInput.value = "";
          populateList("");
          searchInput.focus();
        }

        function closeMenu() {
          dropdown.classList.remove("dev-dropdown--open");
          menu.style.display = "none";
        }

        toggleBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = dropdown.classList.contains("dev-dropdown--open");
          if (isOpen) {
            closeMenu();
          } else {
            openMenu();
          }
        });

        // Click outside to close
        document.addEventListener("click", (e) => {
          if (!dropdown.contains(e.target)) {
            closeMenu();
          }
        });

        // Search input filters list
        searchInput.addEventListener("input", (e) => {
          populateList(e.target.value);
        });

        // Click on list item → select dev
        listEl.addEventListener("click", (e) => {
          const li = e.target.closest(".dev-dropdown-item");
          if (!li) return;
          const key = li.dataset.key;

          const dev = authors.find((a) => (a.email || a.name || "") === key);
          if (dev) {
            labelSpan.textContent = dev.email
              ? `${dev.name} (${dev.email})`
              : dev.name || "Unknown";
            renderDeveloper(dev);
          }
          closeMenu();
        });

        // Initial state
        if (authors.length === 0) {
          labelSpan.textContent = "No developers found";
          renderDeveloper(null);
        } else {
          labelSpan.textContent = "Select developer";
          renderDeveloper(null);
        }

        // Build initial list
        populateList("");
      })
      .catch((err) => {
        console.error("Failed to load analytics JSON (devs)", err);
        panel.classList.add("activity-bar--error");
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const btnOverall = document.getElementById("btn-overall");
    const btnDevs = document.getElementById("btn-devs");
    const tabContent = document.getElementById("tab-content");

    function setActiveButton(activeBtn) {
      [btnOverall, btnDevs].forEach((btn) => {
        if (btn === activeBtn) {
          btn.classList.add("tab-button--active");
        } else {
          btn.classList.remove("tab-button--active");
        }
      });
    }

    function loadTab(url, activeBtn) {
      fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then((response) => response.text())
        .then((html) => {
          tabContent.innerHTML = html;
          setActiveButton(activeBtn);
          // Re-init tab-specific JS after HTML is injected
          initActivityBar();
          initCiReliabilityCharts();
          initDeveloperPanel();
        });
    }

    btnOverall.addEventListener("click", function () {
      loadTab("{% url 'analysis_dashboard_overall' analysis.id %}", btnOverall);
    });

    btnDevs.addEventListener("click", function () {
      loadTab("{% url 'analysis_dashboard_developers' analysis.id %}", btnDevs);
    });

    // Default tab on first load
    loadTab("{% url 'analysis_dashboard_overall' analysis.id %}", btnOverall);
  });
</script>

{% endblock %}
